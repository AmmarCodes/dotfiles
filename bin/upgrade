#!/usr/bin/env bash
set -euo pipefail

pretty_print() {
  gum style \
    --foreground 12 --border-foreground 12 --border double \
    --align center --width 50 "$1"
}

# if [ -x "$(command -v sketchybar)" ]; then
#   pretty_print "Get latest icon_map.lua"
#   latest_tag=$(curl -s https://api.github.com/repos/kvndrsslr/sketchybar-app-font/releases/latest | grep '"tag_name":' | cut -d '"' -f 4)
#   font_url="https://github.com/kvndrsslr/sketchybar-app-font/releases/download/${latest_tag}/icon_map.lua"
#   output_path="$HOME/.dotfiles/sketchybar/helpers/app_icons.lua"
#   mkdir -p "$(dirname "$output_path")"
#   curl -L "$font_url" -o "$output_path"
#   sketchybar --reload
# fi

if [ -x "$(command -v brew)" ]; then
  pretty_print "Upgrading Homebrew packages"
  gum spin --show-output --spinner minidot --title "Updating brew..." -- brew update && brew upgrade
  gum spin --show-output --spinner minidot --title "Cleaning up..." -- brew cleanup --prune=all
  gum spin --show-output --spinner minidot --title "Dumping brew bundle..." -- brew bundle dump --force --tap --cask --formula --services --tap --describe --force --file=~/.dotfiles/Brewfile
fi

# if [ -x "$(command -v npm)" ]; then
# 	echo "Updating npm packages"
# 	npm install -g && npm update -g
# fi

# if [ -x "$(command -v composer)" ]; then
# 	echo "Upgrading composer packages"
# 	composer global update
# fi

if [ -x "$(command -v zinit)" ]; then
  pretty_print "Upgrading zsh plugins"
  zinit self-update
  zinit update --all
  zinit compile --all
fi

if [ -x "$(command -v fisher)" ]; then
  pretty_print "Upgrading fish plugins"
  gum spin --show-output --spinner minidot --title "Updating brew..." -- fisher update

  # set up tide shell settings
  tide configure --auto --style=Lean --prompt_colors='16 colors' --show_time=No --lean_prompt_height='Two lines' --prompt_spacing=Compact --icons='Few icons' --transient=Yes
fi

# echo "Upgrading nvim plugins"
# nvim --headless "+Lazy! sync" +qall
# nvim --headless "+TSUpdateSync" +qall

if [ -x "$(command -v mas)" ]; then
  pretty_print "Upgrading Mac App Store apps"
  gum spin --show-output --spinner minidot --title "Upgrading Mac App Store apps" -- mas upgrade
fi

if [ -d ~/.tmux/plugins/tpm ]; then
  pretty_print "Updating tmux plugins"
  gum spin --show-output --spinner minidot --title "Updating tmux plugins" -- ~/.tmux/plugins/tpm/bin/update_plugins all
fi

if [ -x "$(command -v bob)" ]; then
  pretty_print "Update neovim to latest version"
  bob update
fi
